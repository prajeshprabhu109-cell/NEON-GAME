<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Hustle: Car Race Betting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a2e;
            font-family: 'Roboto Mono', monospace;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #00f0ff;
        }
        .betting-panel {
            background-color: rgba(13, 13, 30, 0.95);
            border: 3px solid #ff007f;
            box-shadow: 0 0 25px rgba(255, 0, 127, 0.7);
            width: 95%;
            max-width: 800px;
            padding: 1.5rem;
            border-radius: 1rem;
        }
        .bet-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            margin-bottom: 1.5rem;
        }
        .bet-table th, .bet-table td {
            padding: 8px 12px;
            border-bottom: 1px dashed rgba(255, 0, 127, 0.3);
        }
        .bet-table th {
            color: #ff007f;
            font-size: 0.8rem;
            text-transform: uppercase;
        }
        .car-color {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        .btn-action {
            background-color: #ff007f;
            color: #0d0d1e;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px #b8005b;
        }
        .btn-secondary {
            background-color: #00f0ff;
            color: #1a1a2e;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px #00aaff;
        }
        .btn-bet {
            padding: 10px 15px;
            border-radius: 0.5rem;
            margin: 5px;
            font-size: 0.9rem;
            background-color: #2a2a4a;
            color: #00f0ff;
            border: 1px solid #00f0ff;
            transition: all 0.1s;
        }
        .btn-bet.selected {
            background-color: #00f0ff;
            color: #1a1a2e;
            box-shadow: 0 0 10px #00f0ff;
        }
        #resultDisplay {
            min-height: 50px;
            margin-top: 1.5rem;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
        }

        /* --- Video Specific Styles --- */
        #videoContainer {
            width: 100%;
            height: 350px; /* Fixed height for video area */
            margin-bottom: 1.5rem;
            border: 2px solid #ff007f;
            overflow: hidden;
            background: black;
        }
        #videoFrame {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
    </head>
<body>

<div class="betting-panel">
    <div class="flex justify-between items-center mb-4 border-b border-white pb-2">
        <h1 class="text-2xl font-bold">RACE BETTING</h1>
        <div class="text-lg">CASH: <span id="currentCash">$5000</span></div>
    </div>

    <div id="videoContainer" style="display: none;">
        <iframe id="videoFrame" src="race-video-player.html"></iframe>
    </div>

    <div id="bettingUI">
        <div class="flex justify-between items-start mb-4">
            <table class="bet-table w-1/2 mr-4">
                <thead>
                    <tr>
                        <th>Car / Name</th>
                        <th>Odds</th>
                    </tr>
                </thead>
                <tbody id="competitorList">
                    </tbody>
            </table>

            <div class="w-1/2">
                <h2 class="text-xl font-bold mb-2 text-white">Your Bet:</h2>
                <div id="selectedCarDisplay" class="text-lg mb-2">PICK A CAR</div>
                <div class="text-lg mb-4">Amount: <span id="betAmountDisplay">$0</span></div>

                <div id="betAmountButtons" class="flex flex-wrap justify-center">
                    <button class="btn-bet" data-amount="100">$100</button>
                    <button class="btn-bet" data-amount="500">$500</button>
                    <button class="btn-bet" data-amount="1000">$1000</button>
                    <button class="btn-bet" data-amount="5000">$5000</button>
                    <button class="btn-bet" data-amount="10000">$10000</button>
                    <button class="btn-bet" data-amount="0" style="background-color: #ff007f;">CLEAR</button>
                </div>

                <button id="placeBetButton" class="btn-action w-full mt-4" onclick="startRaceSimulation()" disabled>
                    PLACE BET
                </button>
            </div>
        </div>
    </div>

    <div id="resultDisplay" class="text-center"></div>

     

    <a href="clubs.html" class="btn-secondary w-full block mt-4 text-center">EXIT CLUBS</a>
</div>

<script type="module">
    // --- IMPORTANT: This file must exist and contain the load/save logic ---
    import { loadPlayerState, savePlayerCash } from './betting-logic.js';

    // --- GAME STATE & CONSTANTS ---
    let playerCash = 5000;
    let selectedCarId = null;
    let betAmount = 0;
    let raceInProgress = false;

    const COMPETITORS = [
        { id: 1, name: "Lewis Hamilton", color: "#00f0ff", odds: 2.0 },
        { id: 2, name: "Charles Leclerc", color: "#ff3333", odds: 3.5 },
        { id: 3, name: "Max Verstappen", color: "#ffff00", odds: 4.5 },
        { id: 4, name: "Sergio Perez", color: "#00ff7f", odds: 6.0 },
        { id: 5, name: "Carlos Sainz", color: "#ff7f00", odds: 8.0 },
    ];

    // --- UTILITY TO RECEIVE VIDEO END MESSAGE ---
    window.addEventListener('message', function(event) {
        // Only process the message if it's the 'video-ended' signal and a race is expected
        if (event.data === 'video-ended' && raceInProgress) {
            processRaceResult();
        }
    });

    // --- INITIALIZATION ---
    async function initializeBettingHub() {
        playerCash = await loadPlayerState();
        updateDisplay();
        renderCompetitors();

        document.getElementById('competitorList').addEventListener('click', handleCarSelection);
        document.getElementById('betAmountButtons').addEventListener('click', handleBetAmount);

        document.getElementById('videoContainer').style.display = 'none';
        document.getElementById('bettingUI').style.display = 'block';
    }

    // --- RENDERING & UI FUNCTIONS (Omitted for brevity, assume unchanged) ---
    function renderCompetitors() {
        const list = document.getElementById('competitorList');
        list.innerHTML = COMPETITORS.map(comp => `
            <tr data-id="${comp.id}" data-odds="${comp.odds}" class="cursor-pointer hover:bg-[#2a2a4a]">
                <td><span class="car-color" style="background-color: ${comp.color};"></span>${comp.name}</td>
                <td>${comp.odds}:1</td>
            </tr>
        `).join('');
    }

    function updateDisplay() {
        document.getElementById('currentCash').textContent = `$${playerCash}`;
        document.getElementById('betAmountDisplay').textContent = `$${betAmount}`;

        const car = COMPETITORS.find(c => c.id === selectedCarId);
        document.getElementById('selectedCarDisplay').innerHTML = car
            ? `<span class="car-color" style="background-color: ${car.color};"></span>${car.name} (${car.odds}:1)`
            : 'PICK A CAR';

        const placeBetButton = document.getElementById('placeBetButton');
        placeBetButton.disabled = !(selectedCarId !== null && betAmount > 0 && betAmount <= playerCash) || raceInProgress;

        document.querySelectorAll('.bet-table tr').forEach(row => {
            row.classList.remove('selected');
            if (parseInt(row.dataset.id) === selectedCarId) {
                row.classList.add('selected');
            }
        });
    }

    function handleCarSelection(event) {
        const row = event.target.closest('tr');
        if (row && row.dataset.id) {
            selectedCarId = parseInt(row.dataset.id);
            updateDisplay();
        }
    }

    function handleBetAmount(event) {
        const button = event.target.closest('button');
        if (button && button.dataset.amount !== undefined) {
            const amount = parseInt(button.dataset.amount);

            if (amount === 0) {
                betAmount = 0;
            } else if (betAmount + amount <= playerCash) {
                betAmount += amount;
            } else {
                betAmount = playerCash;
            }
            updateDisplay();
        }
    }


    // --- CORE SIMULATION / RESULT PROCESSING ---

    async function processRaceResult() {
        // Hide video container immediately
        document.getElementById('videoContainer').style.display = 'none';

        raceInProgress = false;

        const selectedCar = COMPETITORS.find(c => c.id === selectedCarId);
        const resultDisplay = document.getElementById('resultDisplay');
        const placeBetButton = document.getElementById('placeBetButton');

        // 1. Determine Winner based on odds
        const winner = determineWinner(COMPETITORS);

        // 2. Calculate Payout
        let newCash = playerCash; // Cash already deducted at start of simulation
        if (winner.id === selectedCarId) {
            const payout = Math.floor(betAmount * selectedCar.odds);
            newCash += betAmount + payout; // Add back original bet amount + winnings
            resultDisplay.innerHTML = `<span style="color:#00f0ff;">WINNER! ${winner.name} took the prize.</span> You won $${payout}. Total: $${newCash}.`;
        } else {
            // Bet was already deducted, so only display loss message
            resultDisplay.innerHTML = `<span style="color:#ff3333;">LOST. ${winner.name} won.</span> You lost $${betAmount}. Total: $${newCash}.`;
        }

        // 3. Update Cash state and save
        playerCash = newCash;
        await savePlayerCash(playerCash);

        // 4. Reset bet and unlock UI
        selectedCarId = null;
        betAmount = 0;
        updateDisplay();
        placeBetButton.disabled = false;
        placeBetButton.textContent = "PLACE BET";
        document.getElementById('bettingUI').style.display = 'block'; // Show betting table again
    }


    async function startRaceSimulation() {
        if (selectedCarId === null || betAmount <= 0 || betAmount > playerCash || raceInProgress) {
            document.getElementById('resultDisplay').textContent = "Invalid bet or race already in progress.";
            return;
        }

        // 1. Lock UI and deduct cash
        raceInProgress = true;

        // Deduct cash immediately
        playerCash -= betAmount;
        await savePlayerCash(playerCash); // Save deduction immediately
        updateDisplay();

        const selectedCar = COMPETITORS.find(c => c.id === selectedCarId);
        const placeBetButton = document.getElementById('placeBetButton');
        placeBetButton.disabled = true;
        placeBetButton.textContent = "RACING...";

        // 2. Hide betting table and show video
        document.getElementById('bettingUI').style.display = 'none';
        document.getElementById('videoContainer').style.display = 'block';

        // 3. CRITICAL: Force the iframe to reload and play the video (it auto-plays on load)
        const videoFrame = document.getElementById('videoFrame');
        videoFrame.src = videoFrame.src;

        document.getElementById('resultDisplay').textContent = `Placing $${betAmount} on ${selectedCar.name}... WATCH THE RACE!`;
    }

    // --- CORE GAME LOGIC (Simulation) ---
    function determineWinner(competitors) {
        let totalOdds = competitors.reduce((sum, c) => sum + (1 / c.odds), 0);
        let randomValue = Math.random() * totalOdds;

        let cumulativeProbability = 0;
        for (const comp of competitors) {
            cumulativeProbability += (1 / comp.odds);
            if (randomValue <= cumulativeProbability) {
                return comp;
            }
        }
        return competitors[Math.floor(Math.random() * competitors.length)];
    }

    // --- INITIALIZATION ---
    window.startRaceSimulation = startRaceSimulation;

    window.onload = initializeBettingHub;

</script>

</body>
</html>